# üîß –ò–ó–ú–ï–ù–ï–ù–ò–Ø: –°–∏—Å—Ç–µ–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ (Token Refresh System)

**–î–∞—Ç–∞:** 3 –º–∞—Ä—Ç–∞ 2026 –≥.  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ  
**–í–ª–∏—è–Ω–∏–µ:** –ö—Ä–∏—Ç–∏—á–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ - –±–æ–ª—å—à–µ –Ω–µ—Ç –ø–µ—Ä–µ–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞

---

## üìã –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ç—Ä–µ–±–æ–≤–∞–ª–æ –ø–µ—Ä–µ–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞, –¥–∞–∂–µ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤—ã—Ö–æ–¥–∏–ª –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –≠—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ –ø–æ –ø—Ä–∏—á–∏–Ω–µ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ HTTP 401 –æ—à–∏–±–æ–∫ –≤ ApiService.

---

## ‚úÖ –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. **ApiService** (`lib/services/api_service.dart`)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç —á–∞—Å—Ç—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ refresh (debounce 2 —Å–µ–∫—É–Ω–¥—ã)
- ‚úÖ –ü—Ä–∏ 401 –æ—à–∏–±–∫–µ: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ + –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry –∑–∞–ø—Ä–æ—Å–∞
- ‚úÖ –í—Å–µ –º–µ—Ç–æ–¥—ã GET/POST/PUT/DELETE —Ç–µ–ø–µ—Ä—å —á–∏—Ç–∞—é—Ç —Ç–æ–∫–µ–Ω –∏–∑ Hive –µ—Å–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è 401 ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ TokenExpiredEvent

### 2. **TokenService** (`lib/services/token_service.dart`)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç —á–∞—Å—Ç—ã—Ö refresh –ø–æ–ø—ã—Ç–æ–∫ —Å debounce –º–µ—Ö–∞–Ω–∏–∑–º–æ–º
- ‚úÖ –ü—Ä–∏ –æ—à–∏–±–∫–µ refresh: –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 30 —Å–µ–∫—É–Ω–¥ –≤–º–µ—Å—Ç–æ immediate failure
- ‚úÖ –£–ª—É—á—à–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ (forceRefresh)

### 3. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** 
- ‚úÖ –°–æ–∑–¥–∞–Ω –ø–æ–¥—Ä–æ–±–Ω—ã–π —Ñ–∞–π–ª [TOKEN_REFRESH_FIX.md](TOKEN_REFRESH_FIX.md) —Å –ø–æ–ª–Ω—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º

---

## üîÑ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–µ–ø–µ—Ä—å

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ü—Ä–æ–∞–∫—Ç–∏–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–Ω–æ—Ä–º–∞)
```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚Üí TokenService.init()
2. –¢–∞–π–º–µ—Ä –∂–¥–µ—Ç 55 –º–∏–Ω—É—Ç (–∑–∞ 5 –º–∏–Ω—É—Ç –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è)
3. TokenService –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω
4. –ù–æ–≤—ã–π —Ç–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ Hive
5. –í—Å–µ —Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω ‚úÖ
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –¢–æ–∫–µ–Ω –∏—Å—Ç–µ–∫–∞–µ—Ç –≤–æ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞
```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–ª–∞–µ—Ç API –∑–∞–ø—Ä–æ—Å
2. –°–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 401 (—Ç–æ–∫–µ–Ω –∏—Å—Ç–µ–∫)
3. ApiService –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É
4. –û–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω –≤ Hive
5. –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å —Å –Ω–æ–≤—ã–º —Ç–æ–∫–µ–Ω–æ–º ‚úÖ
6. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–∞–∂–µ –Ω–µ –∑–∞–º–µ—á–∞–µ—Ç —á—Ç–æ-—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å ‚úÖ
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ß–∞—Å—Ç—ã–µ –∑–∞–ø—Ä–æ—Å—ã –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
```
1. 5 –∑–∞–ø—Ä–æ—Å–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–ª—É—á–∞—é—Ç 401
2. –¢–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–π –¥–µ–ª–∞–µ—Ç refresh (debounce)
3. –û—Å—Ç–∞–ª—å–Ω—ã–µ 4 –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω ‚úÖ
4. –ù–µ—Ç –ª–∏—à–Ω–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ —Å–µ—Ä–≤–µ—Ä—É ‚úÖ
```

---

## üöÄ –ü—Ä–µ–∏–º—É—â—Å—Ç–≤–∞

| –ß—Ç–æ | –ë—ã–ª–æ | –°—Ç–∞–ª–æ |
|-----|------|-------|
| **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** | ‚ùå –ù–µ—Ç | ‚úÖ –î–∞ (–∑–∞ 5 –º–∏–Ω –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è) |
| **Retry –ø—Ä–∏ 401** | ‚ùå –í—ã–∑—ã–≤–∞—é—â–∏–π –∫–æ–¥ —Å–∞–º | ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π |
| **–ß–∞—Å—Ç—ã–µ refresh –∑–∞–ø—Ä–æ—Å—ã** | ‚ùå –í–æ–∑–º–æ–∂–Ω—ã infinite loops | ‚úÖ Debounce 2—Å–µ–∫ |
| **–ü–µ—Ä–µ–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è** | ‚ùå –ß–∞—Å—Ç–æ | ‚úÖ –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ refresh –Ω–µ —É–¥–∞–ª—Å—è |
| **–ß–∏—Ç–∞–µ–º–æ—Å—Ç—å –∫–æ–¥–∞** | ‚ùå –°–ª–æ–∂–Ω–æ | ‚úÖ –ü–æ–Ω—è—Ç–Ω–æ |

---

## üìù –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### Debounce –º–µ—Ö–∞–Ω–∏–∑–º
- –ú–∞–∫—Å–∏–º—É–º **–æ–¥–∏–Ω refresh –≤ 2 —Å–µ–∫—É–Ω–¥—ã** (–≤ ApiService)
- –ú–∞–∫—Å–∏–º—É–º **–æ–¥–∏–Ω refresh –≤ 2 —Å–µ–∫—É–Ω–¥—ã** (–≤ TokenService)
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç infinite loops –∏ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ API

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —á—Ç–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –∏–∑ Hive
```dart
// –†–∞–Ω—å—à–µ (—è–≤–Ω—ã–π token –ø–∞—Ä–∞–º–µ—Ç—Ä –≤—Å–µ–≥–¥–∞ —Ç—Ä–µ–±–æ–≤–∞–ª—Å—è):
final token = await HiveService.getUserData('token');
final result = await ApiService.post('/endpoint', data, token: token);

// –¢–µ–ø–µ—Ä—å (–µ—Å–ª–∏ token –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω - –±–µ—Ä–µ—Ç—Å—è –∏–∑ Hive –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏):
final result = await ApiService.post('/endpoint', data); // ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç!
// –ò–ª–∏ —Å—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–± –≤—Å–µ –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:
final token = await HiveService.getUserData('token');
final result = await ApiService.post('/endpoint', data, token: token); // ‚úÖ –¢–æ–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!
```

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ retry —Ü–∏–∫–ª–∞
```dart
for (int attempt = 0; attempt < 4; attempt++) {
  try {
    return await request();
  } on TokenExpiredException {
    if (tokenExpiredAttempts == 0) {
      // –ü–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞ - –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω –∏ –ø–æ–≤—Ç–æ—Ä—è–µ–º
      final newToken = await refreshToken(currentToken);
      if (newToken != null) {
        continue; // –ü–æ–≤—Ç–æ—Ä—è–µ–º –∑–∞–ø—Ä–æ—Å —Å–æ —Å–ª–µ–¥—É—é—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏
      }
    }
    // –í—Ç–æ—Ä–∞—è –ø–æ–ø—ã—Ç–∫–∞ –≤—Å–µ –µ—â–µ 401 - –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º
    rethrow;
  }
}
```

---

## üß™ –ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### –¢–µ—Å—Ç 1: –ü—Ä–æ–∞–∫—Ç–∏–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
1. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
2. –ü–æ–¥–æ–∂–¥–∏—Ç–µ ~55 –º–∏–Ω—É—Ç (–∏–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ç–æ–∫–µ–Ω —Å –∫–æ—Ä–æ—Ç–∫–∏–º lifetime)
3. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Ç–æ–∫–µ–Ω –æ–±–Ω–æ–≤–∏–ª—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
4. –°–¥–µ–ª–∞–π—Ç–µ API –∑–∞–ø—Ä–æ—Å - –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –ø–µ—Ä–µ–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ‚úÖ

### –¢–µ—Å—Ç 2: –¢–æ–∫–µ–Ω –∏—Å—Ç–µ–∫–∞–µ—Ç –≤–æ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞
1. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å
2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ç–æ–∫–µ–Ω –≤—Ä—É—á–Ω—É—é –Ω–∞ –∏—Å—Ç–µ–∫—à–∏–π (–∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π —Ç–æ–∫–µ–Ω)
3. –°–¥–µ–ª–∞–π—Ç–µ API –∑–∞–ø—Ä–æ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–∞–≥—Ä—É–∑–∏—Ç–µ –ª–∏—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π)
4. –û–Ω –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –ø–µ—Ä–µ–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ‚úÖ

### –¢–µ—Å—Ç 3: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
1. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å
2. –°–¥–µ–ª–∞–π—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ API –∑–∞–ø—Ä–æ—Å–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
3. –í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω refresh –∑–∞–ø—Ä–æ—Å (debounce) ‚úÖ

---

## üí• –†–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ **–ë–æ–ª—å—à–µ –Ω–µ—Ç –ø–µ—Ä–µ–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞**  
‚úÖ **–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç seamlessly –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–∞**  
‚úÖ **–ó–∞—â–∏—Ç–∞ –æ—Ç –ª–∏—à–Ω–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API**  
‚úÖ **–ü–æ–ª–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º**

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

–ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π, –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏ –≤–æ–∑–º–æ–∂–Ω—ã–º–∏ —É–ª—É—á—à–µ–Ω–∏—è–º–∏ —Å–º. –≤ —Ñ–∞–π–ª–µ:
**[docs/TOKEN_REFRESH_FIX.md](docs/TOKEN_REFRESH_FIX.md)**
